# xlsx_to_google

Скрипт для автоматической загрузки данных из Excel файлов (xlsx) в Google Sheets. Обрабатывает файлы из папки `tables/`, извлекает данные согласно заданному маппингу колонок и записывает их в указанную вкладку Google таблицы.

## Требования

- Python 3.10 или выше
- Аккаунт Google с доступом к Google Sheets API
- Файл учетных данных сервисного аккаунта Google (`google-api-key.json`)
- Доступ к Google таблице, в которую будут загружаться данные

## Установка зависимостей

1. Создайте виртуальное окружение (рекомендуется):

```bash
python3 -m venv venv
```

2. Активируйте виртуальное окружение:

**На macOS/Linux:**
```bash
source venv/bin/activate
```

**На Windows:**
```bash
venv\Scripts\activate
```

3. Установите необходимые зависимости:

```bash
pip install -r requirements.txt
```

## Настройка Google API

1. Перейдите в [Google Cloud Console](https://console.cloud.google.com/)
2. Создайте новый проект или выберите существующий
3. Включите Google Sheets API для вашего проекта
4. Создайте сервисный аккаунт:
   - Перейдите в "IAM & Admin" → "Service Accounts"
   - Нажмите "Create Service Account"
   - Заполните необходимые данные и создайте аккаунт
5. Создайте ключ для сервисного аккаунта:
   - Выберите созданный сервисный аккаунт
   - Перейдите на вкладку "Keys"
   - Нажмите "Add Key" → "Create new key"
   - Выберите формат JSON и скачайте файл
6. Сохраните скачанный JSON файл как `google-api-key.json` в корне проекта
7. Предоставьте доступ сервисному аккаунту к вашей Google таблице:
   - Откройте вашу Google таблицу
   - Нажмите "Настройки доступа" (Share)
   - Добавьте email сервисного аккаунта (находится в поле `client_email` файла `google-api-key.json`) с правами редактора

## Настройка переменных окружения

1. Создайте файл `.env` в корне проекта:

```bash
touch .env
```

2. Добавьте в файл `.env` следующую переменную:

```env
GOOGLE_TABLE_ID=ваш_идентификатор_таблицы
```

**Как получить GOOGLE_TABLE_ID:**
- Откройте вашу Google таблицу в браузере
- Идентификатор находится в URL между `/d/` и `/edit`
- Например, для URL `https://docs.google.com/spreadsheets/d/1a2b3c4d5e6f7g8h9i0j/edit` идентификатор будет `1a2b3c4d5e6f7g8h9i0j`

**Пример файла `.env`:**
```env
GOOGLE_TABLE_ID=1a2b3c4d5e6f7g8h9i0j
```

## Структура проекта

```
xlsx_to_google/
├── main.py                 # Основной скрипт
├── requirements.txt        # Зависимости проекта
├── google-api-key.json     # Учетные данные Google API (не в git)
├── .env                    # Переменные окружения (не в git)
├── tables/                 # Папка с xlsx файлами для обработки
│   ├── file1.xlsx
│   ├── file2.xlsx
│   └── file1.xlsx.success  # Маркеры обработанных файлов
└── venv/                   # Виртуальное окружение (не в git)
```

### Формат xlsx файлов

Скрипт ожидает файлы со следующей структурой:
- Лист должен называться **"Отчет"**
- В ячейке **A1** должна находиться дата (скрипт извлечет последнее слово из этой ячейки)
- В **строке 6** (индекс 5) должны находиться заголовки колонок
- Данные начинаются с **строки 7**

### Маппинг колонок

Скрипт автоматически преобразует следующие колонки из xlsx в Google таблицу:

| Колонка в xlsx | Колонка в Google Sheets |
|----------------|-------------------------|
| Дата визита    | Дата                    |
| UTM Source     | utm_source              |
| UTM Medium     | utm_medium              |
| UTM Campaign   | utm_campaign            |
| UTM Term       | UTM-Term                |
| Визиты         | visits                  |
| Отказы         | bounceRate              |
| Глубина просмотра | pageDepth           |
| Время на сайте | avgVisitDurationSeconds |
| Роботность     | robotPercentage         |

Дополнительно можно указать колонки для суммирования в `GoalActions` (см. раздел "Запуск скрипта").

## Запуск скрипта

### Базовый запуск

Минимальная команда для запуска (обязательно указать имя вкладки):

```bash
python main.py --worksheet "Имя вкладки"
```

или короткая форма:

```bash
python main.py -w "Имя вкладки"
```

### Запуск с суммированием колонок в GoalActions

Если нужно суммировать значения из нескольких колонок xlsx файла в колонку `GoalActions`:

```bash
python main.py -w "Имя вкладки" --goal-actions-columns "Колонка 1" "Колонка 2" "Колонка 3"
```

или короткая форма:

```bash
python main.py -w "Имя вкладки" -g "Колонка 1" "Колонка 2" "Колонка 3"
```

### Примеры использования

**Пример 1:** Загрузка данных во вкладку "Данные":
```bash
python main.py -w "Данные"
```

**Пример 2:** Загрузка данных с суммированием колонок "Конверсии" и "Заказы":
```bash
python main.py -w "Отчет" -g "Конверсии" "Заказы"
```

**Пример 3:** Загрузка данных во вкладку с пробелами в названии:
```bash
python main.py --worksheet "Мой отчет"
```

## Параметры командной строки

- `--worksheet` / `-w` (обязательный) — имя вкладки в Google таблице, куда будут загружаться данные
- `--goal-actions-columns` / `-g` (опциональный) — названия колонок в xlsx файле, значения которых будут суммироваться в колонку `GoalActions`. Можно указать несколько колонок через пробел

## Дополнительная информация

### Механизм обработки файлов

- Скрипт обрабатывает все `.xlsx` файлы из папки `tables/`
- После успешной обработки файла создается маркерный файл с расширением `.success` (например, `file.xlsx.success`)
- Файлы с маркером `.success` пропускаются при следующих запусках скрипта
- Это позволяет избежать дублирования данных при повторных запусках

### Формат данных

- Дата извлекается из ячейки A1 листа "Отчет" (берется последнее слово после пробела)
- Все строки данных из xlsx файла добавляются в Google таблицу с этой датой
- Пустые значения в колонках игнорируются при записи
- Для колонки `GoalActions` суммируются числовые значения из указанных колонок (поддерживаются как числа, так и строки с запятой или точкой в качестве разделителя)

### Структура Google таблицы

- Первая строка таблицы должна содержать заголовки колонок
- Скрипт автоматически определяет позиции колонок по заголовкам
- Новые данные добавляются после последней заполненной строки
- Если заголовки не найдены, скрипт выведет предупреждение и завершит работу

### Устранение неполадок

**Ошибка: "FileNotFoundError: google-api-key.json"**
- Убедитесь, что файл `google-api-key.json` находится в корне проекта
- Проверьте правильность имени файла

**Ошибка: "gspread.exceptions.SpreadsheetNotFound"**
- Проверьте правильность `GOOGLE_TABLE_ID` в файле `.env`
- Убедитесь, что сервисный аккаунт имеет доступ к таблице

**Ошибка: "gspread.exceptions.WorksheetNotFound"**
- Проверьте правильность имени вкладки (учитывается регистр)
- Убедитесь, что вкладка существует в Google таблице

**Предупреждение: "Заголовки не найдены в таблице"**
- Убедитесь, что первая строка Google таблицы содержит заголовки из списка маппинга
- Проверьте точное соответствие названий заголовков (учитывается регистр и пробелы)
